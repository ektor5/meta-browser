From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Raine Makelainen <raine.makelainen@jolla.com>
Date: Tue, 11 Aug 2020 17:09:44 +0300
Subject: [PATCH] [sailfishos][gecko] Make TabChild to work with TabChildHelper

Signed-off-by: Raine Makelainen <raine.makelainen@jolla.com>
Signed-off-by: Pavel Tumakaev <p.tumakaev@omprussia.ru>
---
 dom/base/nsFocusManager.cpp |  2 +-
 dom/ipc/TabChild.cpp        | 10 +++++++++-
 dom/ipc/TabChild.h          | 11 +++++++----
 3 files changed, 17 insertions(+), 6 deletions(-)

diff --git a/dom/base/nsFocusManager.cpp b/dom/base/nsFocusManager.cpp
index 4d2f86dc1dc1..7b9f4c847b3a 100644
--- a/dom/base/nsFocusManager.cpp
+++ b/dom/base/nsFocusManager.cpp
@@ -857,7 +857,7 @@ nsFocusManager::WindowShown(mozIDOMWindowProxy* aWindow, bool aNeedsFocus) {
 
   if (nsIDocShell* docShell = window->GetDocShell()) {
     if (nsCOMPtr<nsITabChild> child = docShell->GetTabChild()) {
-      bool active = static_cast<TabChild*>(child.get())->ParentIsActive();
+      bool active = dynamic_cast<TabChildBase*>(child.get())->ParentIsActive();
       ActivateOrDeactivate(window, active);
     }
   }
diff --git a/dom/ipc/TabChild.cpp b/dom/ipc/TabChild.cpp
index fdb1db09fdad..4738d894ea82 100644
--- a/dom/ipc/TabChild.cpp
+++ b/dom/ipc/TabChild.cpp
@@ -263,10 +263,12 @@ void TabChildBase::ProcessUpdateFrame(const FrameMetrics& aFrameMetrics) {
 
 NS_IMETHODIMP
 ContentListener::HandleEvent(nsIDOMEvent* aEvent) {
+#if 0
   RemoteDOMEvent remoteEvent;
   remoteEvent.mEvent = do_QueryInterface(aEvent);
   NS_ENSURE_STATE(remoteEvent.mEvent);
   mTabChild->SendEvent(remoteEvent);
+#endif
   return NS_OK;
 }
 
@@ -3151,7 +3153,7 @@ void TabChild::BeforeUnloadRemoved() {
 
 mozilla::dom::TabGroup* TabChild::TabGroup() { return mTabGroup; }
 
-TabChildGlobal::TabChildGlobal(TabChild* aTabChild) : mTabChild(aTabChild) {
+TabChildGlobal::TabChildGlobal(TabChildBase *aTabChild) : mTabChild(aTabChild) {
   SetIsNotDOMBinding();
 }
 
@@ -3246,23 +3248,29 @@ JSObject* TabChildGlobal::GetGlobalJSObject() {
 
 nsresult TabChildGlobal::Dispatch(TaskCategory aCategory,
                                   already_AddRefed<nsIRunnable>&& aRunnable) {
+#if 0
   if (mTabChild && mTabChild->TabGroup()) {
     return mTabChild->TabGroup()->Dispatch(aCategory, Move(aRunnable));
   }
+#endif
   return DispatcherTrait::Dispatch(aCategory, Move(aRunnable));
 }
 
 nsISerialEventTarget* TabChildGlobal::EventTargetFor(
     TaskCategory aCategory) const {
+#if 0
   if (mTabChild && mTabChild->TabGroup()) {
     return mTabChild->TabGroup()->EventTargetFor(aCategory);
   }
+#endif
   return DispatcherTrait::EventTargetFor(aCategory);
 }
 
 AbstractThread* TabChildGlobal::AbstractMainThreadFor(TaskCategory aCategory) {
+#if 0
   if (mTabChild && mTabChild->TabGroup()) {
     return mTabChild->TabGroup()->AbstractMainThreadFor(aCategory);
   }
+#endif
   return DispatcherTrait::AbstractMainThreadFor(aCategory);
 }
diff --git a/dom/ipc/TabChild.h b/dom/ipc/TabChild.h
index bfe029b51dcd..c45d70a5db56 100644
--- a/dom/ipc/TabChild.h
+++ b/dom/ipc/TabChild.h
@@ -79,6 +79,7 @@ class TabGroup;
 class ClonedMessageData;
 class CoalescedMouseData;
 class CoalescedWheelData;
+class TabChildBase;
 
 class TabChildGlobal : public DOMEventTargetHelper,
                        public nsIContentFrameMessageManager,
@@ -86,7 +87,7 @@ class TabChildGlobal : public DOMEventTargetHelper,
                        public nsIGlobalObject,
                        public nsSupportsWeakReference {
  public:
-  explicit TabChildGlobal(TabChild* aTabChild);
+  explicit TabChildGlobal(TabChildBase* aTabChild);
   void Init();
   NS_DECL_ISUPPORTS_INHERITED
   NS_DECL_CYCLE_COLLECTION_CLASS_INHERITED(TabChildGlobal, DOMEventTargetHelper)
@@ -158,7 +159,7 @@ class TabChildGlobal : public DOMEventTargetHelper,
       mozilla::TaskCategory aCategory) override;
 
   nsCOMPtr<nsIContentFrameMessageManager> mMessageManager;
-  RefPtr<TabChild> mTabChild;
+  RefPtr<TabChildBase> mTabChild;
 
  protected:
   ~TabChildGlobal();
@@ -166,12 +167,12 @@ class TabChildGlobal : public DOMEventTargetHelper,
 
 class ContentListener final : public nsIDOMEventListener {
  public:
-  explicit ContentListener(TabChild* aTabChild) : mTabChild(aTabChild) {}
+  explicit ContentListener(TabChildBase* aTabChild) : mTabChild(aTabChild) {}
   NS_DECL_ISUPPORTS
   NS_DECL_NSIDOMEVENTLISTENER
  protected:
   ~ContentListener() {}
-  TabChild* mTabChild;
+  TabChildBase* mTabChild;
 };
 
 // This is base clase which helps to share Viewport and touch related
@@ -200,6 +201,8 @@ class TabChildBase : public nsISupports,
 
   virtual ScreenIntSize GetInnerSize() = 0;
 
+  virtual bool ParentIsActive() const = 0;
+
   // Get the Document for the top-level window in this tab.
   already_AddRefed<nsIDocument> GetDocument() const;
 
-- 
2.25.1

